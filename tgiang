-- Đợi cho game load hoàn toàn
repeat task.wait() until game:IsLoaded()
print("Game đã tải xong, bắt đầu chạy script...")

-- Biến toàn cục
getgenv().Team = "Pirates"
wait(2)
-- Khai báo trước các hàm để cập nhật GUI
function UpdateStatus(status)
    if _G.StatusLabel then
        _G.StatusLabel.Text = status
    end
end

function UpdateWorld(world)
    if _G.WorldLabel then
        _G.WorldLabel.Text = world
    end
end

function UpdateFruits(fruits)
    if _G.FruitsLabel then
        _G.FruitsLabel.Text = fruits
    end
end

-- Tạo GUI đơn giản chờ chọn team
local function CreateWaitingGUI()
    local BFGui = Instance.new("ScreenGui")
    BFGui.Name = "BFWaitingGUI"
    BFGui.ResetOnSpawn = false
    BFGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    pcall(function()
        BFGui.Parent = game:GetService("CoreGui")
    end)
    
    if not BFGui.Parent then
        BFGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    end
    
    local WaitingFrame = Instance.new("Frame")
    WaitingFrame.Name = "WaitingFrame"
    WaitingFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    WaitingFrame.BorderSizePixel = 0
    WaitingFrame.Position = UDim2.new(0.5, -150, 0.5, -50)
    WaitingFrame.Size = UDim2.new(0, 300, 0, 100)
    WaitingFrame.Parent = BFGui
    
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 10)
    UICorner.Parent = WaitingFrame
    
    local WaitingText = Instance.new("TextLabel")
    WaitingText.Name = "WaitingText"
    WaitingText.BackgroundTransparency = 1
    WaitingText.Position = UDim2.new(0, 10, 0, 10)
    WaitingText.Size = UDim2.new(1, -20, 0, 30)
    WaitingText.Font = Enum.Font.GothamBold
    WaitingText.Text = "Vui lòng chọn team Pirates"
    WaitingText.TextColor3 = Color3.fromRGB(255, 255, 255)
    WaitingText.TextSize = 16
    WaitingText.Parent = WaitingFrame
    
    local StatusText = Instance.new("TextLabel")
    StatusText.Name = "StatusText"
    StatusText.BackgroundTransparency = 1
    StatusText.Position = UDim2.new(0, 10, 0, 50)
    StatusText.Size = UDim2.new(1, -20, 0, 30)
    StatusText.Font = Enum.Font.Gotham
    StatusText.Text = "Đang chờ..."
    StatusText.TextColor3 = Color3.fromRGB(200, 200, 200)
    StatusText.TextSize = 14
    StatusText.Parent = WaitingFrame
    
    return {
        ScreenGui = BFGui,
        WaitingFrame = WaitingFrame,
        StatusText = StatusText
    }
end

-- Kiểm tra và chọn team
local function WaitForTeamSelection()
    local waitingGUI = CreateWaitingGUI()
    
    -- Kiểm tra team hiện tại
    local function CheckTeam()
        local player = game:GetService("Players").LocalPlayer
        if player.Team and player.Team.Name == getgenv().Team then
            return true
        end
        return false
    end
    
    -- Thực hiện chọn team
    spawn(function()
        while wait(1) do
            local player = game:GetService("Players").LocalPlayer
            
            if CheckTeam() then
                waitingGUI.StatusText.Text = "Đã chọn team " .. getgenv().Team .. "!"
                wait(1)
                waitingGUI.ScreenGui:Destroy()
                return
            else
                waitingGUI.StatusText.Text = "Đang chọn team " .. getgenv().Team .. "..."
                game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("SetTeam", getgenv().Team)
            end
        end
    end)
    
    -- Chờ cho đến khi đã chọn team
    while not CheckTeam() do
        wait(0.5)
    end
    
    wait(1) -- Đợi thêm 1 giây để hiển thị thông báo đã chọn team
    waitingGUI.ScreenGui:Destroy()
end

-- Module quản lý hiệu ứng làm mờ
local BlurManager = {}
BlurManager.IsEnabled = false

-- Khởi tạo module
BlurManager.Initialize = function()
    BlurManager.Lighting = game:GetService("Lighting")
    BlurManager.BlurName = "BloxFruitBlur"
    
    -- Đảm bảo không có blur effect cũ
    local existingBlur = BlurManager.Lighting:FindFirstChild(BlurManager.BlurName)
    if existingBlur then
        existingBlur:Destroy()
    end
    
    -- Tạo blur effect mới
    BlurManager.BlurEffect = Instance.new("BlurEffect")
    BlurManager.BlurEffect.Name = BlurManager.BlurName
    BlurManager.BlurEffect.Size = 24
    BlurManager.BlurEffect.Enabled = false
    BlurManager.BlurEffect.Parent = BlurManager.Lighting
    
    -- Đảm bảo xóa hiệu ứng blur khi script kết thúc
    game:GetService("Players").LocalPlayer.CharacterAdded:Connect(function()
        pcall(function()
            local existingBlur = BlurManager.Lighting:FindFirstChild(BlurManager.BlurName)
            if existingBlur then
                existingBlur:Destroy()
            end
        end)
    end)
end

-- Chuyển đổi trạng thái blur
BlurManager.ToggleBlur = function(forceState)
    -- Nếu forceState được cung cấp, sử dụng giá trị đó
    -- Nếu không, đảo ngược trạng thái hiện tại
    if forceState ~= nil then
        BlurManager.IsEnabled = forceState
    else
        BlurManager.IsEnabled = not BlurManager.IsEnabled
    end
    
    -- Áp dụng trạng thái mới
    if BlurManager.BlurEffect then
        BlurManager.BlurEffect.Enabled = BlurManager.IsEnabled
        
        if BlurManager.IsEnabled then
            print()
        else
            print()
        end
    end
    
    return BlurManager.IsEnabled
end

-- Tạo GUI đẹp
local function CreateGUI()
    -- Khởi tạo BlurManager
    BlurManager.Initialize()
    
    -- Tạo ScreenGui
    local BFGui = Instance.new("ScreenGui")
    BFGui.Name = "BFAutoFruitGUI"
    BFGui.ResetOnSpawn = false
    BFGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    -- Sử dụng pcall để tránh lỗi khi đặt Parent
    pcall(function()
        BFGui.Parent = game:GetService("CoreGui")
    end)
    
    -- Nếu không đặt được vào CoreGui, thì đặt vào PlayerGui
    if not BFGui.Parent then
        BFGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    end
    
    -- Tạo khung chính ở giữa màn hình
    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    MainFrame.BorderSizePixel = 0
    MainFrame.Position = UDim2.new(0.5, -200, 0.5, -150) -- Đặt vào giữa màn hình
    MainFrame.Size = UDim2.new(0, 400, 0, 300) -- Kích thước lớn hơn
    MainFrame.Parent = BFGui
    
    -- Tạo hiệu ứng bo góc
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 10)
    UICorner.Parent = MainFrame
    
    -- Tạo thanh tiêu đề - có thể kéo thả
    local TitleBar = Instance.new("Frame")
    TitleBar.Name = "TitleBar"
    TitleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    TitleBar.BorderSizePixel = 0
    TitleBar.Size = UDim2.new(1, 0, 0, 30)
    TitleBar.Parent = MainFrame
    
    -- Bo góc thanh tiêu đề
    local TitleCorner = Instance.new("UICorner")
    TitleCorner.CornerRadius = UDim.new(0, 10)
    TitleCorner.Parent = TitleBar
    
    -- Tiêu đề
    local Title = Instance.new("TextLabel")
    Title.Name = "Title"
    Title.BackgroundTransparency = 1
    Title.Position = UDim2.new(0, 10, 0, 0)
    Title.Size = UDim2.new(1, -80, 1, 0)
    Title.Font = Enum.Font.GothamBold
    Title.Text = "Auto Fruit"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.TextSize = 16
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.Parent = TitleBar
    
    -- Nút đóng GUI
    local CloseButton = Instance.new("TextButton")
    CloseButton.Name = "CloseButton"
    CloseButton.BackgroundColor3 = Color3.fromRGB(192, 57, 43)
    CloseButton.BorderSizePixel = 0
    CloseButton.Position = UDim2.new(1, -70, 0, 5)
    CloseButton.Size = UDim2.new(0, 20, 0, 20)
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.Text = "X"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.TextSize = 14
    CloseButton.Parent = TitleBar
    
    -- Bo góc nút đóng
    local CloseCorner = Instance.new("UICorner")
    CloseCorner.CornerRadius = UDim.new(0, 4)
    CloseCorner.Parent = CloseButton
    
    -- Nút thu nhỏ/phóng to
    local MinimizeButton = Instance.new("TextButton")
    MinimizeButton.Name = "MinimizeButton"
    MinimizeButton.BackgroundColor3 = Color3.fromRGB(41, 128, 185)
    MinimizeButton.BorderSizePixel = 0
    MinimizeButton.Position = UDim2.new(1, -40, 0, 5)
    MinimizeButton.Size = UDim2.new(0, 20, 0, 20)
    MinimizeButton.Font = Enum.Font.GothamBold
    MinimizeButton.Text = "-"
    MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    MinimizeButton.TextSize = 14
    MinimizeButton.Parent = TitleBar
    
    -- Bo góc nút thu nhỏ
    local MinimizeCorner = Instance.new("UICorner")
    MinimizeCorner.CornerRadius = UDim.new(0, 4)
    MinimizeCorner.Parent = MinimizeButton
    
    -- Khung nội dung
    local ContentFrame = Instance.new("Frame")
    ContentFrame.Name = "ContentFrame"
    ContentFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    ContentFrame.BorderSizePixel = 0
    ContentFrame.Position = UDim2.new(0, 10, 0, 40)
    ContentFrame.Size = UDim2.new(1, -20, 1, -50)
    ContentFrame.Parent = MainFrame
    
    -- Bo góc khung nội dung
    local ContentCorner = Instance.new("UICorner")
    ContentCorner.CornerRadius = UDim.new(0, 8)
    ContentCorner.Parent = ContentFrame
    
    -- Tiêu đề trạng thái
    local StatusTitle = Instance.new("TextLabel")
    StatusTitle.Name = "StatusTitle"
    StatusTitle.BackgroundTransparency = 1
    StatusTitle.Position = UDim2.new(0, 10, 0, 10)
    StatusTitle.Size = UDim2.new(1, -20, 0, 20)
    StatusTitle.Font = Enum.Font.GothamSemibold
    StatusTitle.Text = "Script Status"
    StatusTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    StatusTitle.TextSize = 14
    StatusTitle.TextXAlignment = Enum.TextXAlignment.Left
    StatusTitle.Parent = ContentFrame
    
    -- Trạng thái
    _G.StatusLabel = Instance.new("TextLabel")
    _G.StatusLabel.Name = "Status"
    _G.StatusLabel.BackgroundTransparency = 1
    _G.StatusLabel.Position = UDim2.new(0, 10, 0, 35)
    _G.StatusLabel.Size = UDim2.new(1, -20, 0, 20)
    _G.StatusLabel.Font = Enum.Font.Gotham
    _G.StatusLabel.Text = "Waiting..."
    _G.StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    _G.StatusLabel.TextSize = 14
    _G.StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
    _G.StatusLabel.Parent = ContentFrame
    
    -- World Status
    local WorldTitle = Instance.new("TextLabel")
    WorldTitle.Name = "WorldTitle"
    WorldTitle.BackgroundTransparency = 1
    WorldTitle.Position = UDim2.new(0, 10, 0, 65)
    WorldTitle.Size = UDim2.new(1, -20, 0, 20)
    WorldTitle.Font = Enum.Font.GothamSemibold
    WorldTitle.Text = "World"
    WorldTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    WorldTitle.TextSize = 14
    WorldTitle.TextXAlignment = Enum.TextXAlignment.Left
    WorldTitle.Parent = ContentFrame
    
    _G.WorldLabel = Instance.new("TextLabel")
    _G.WorldLabel.Name = "World"
    _G.WorldLabel.BackgroundTransparency = 1
    _G.WorldLabel.Position = UDim2.new(0, 10, 0, 90)
    _G.WorldLabel.Size = UDim2.new(1, -20, 0, 20)
    _G.WorldLabel.Font = Enum.Font.Gotham
    _G.WorldLabel.Text = "Checking..."
    _G.WorldLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    _G.WorldLabel.TextSize = 14
    _G.WorldLabel.TextXAlignment = Enum.TextXAlignment.Left
    _G.WorldLabel.Parent = ContentFrame
    
    -- Fruits Status
    local FruitsTitle = Instance.new("TextLabel")
    FruitsTitle.Name = "FruitsTitle"
    FruitsTitle.BackgroundTransparency = 1
    FruitsTitle.Position = UDim2.new(0, 10, 0, 120)
    FruitsTitle.Size = UDim2.new(1, -20, 0, 20)
    FruitsTitle.Font = Enum.Font.GothamSemibold
    FruitsTitle.Text = "Fruits"
    FruitsTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    FruitsTitle.TextSize = 14
    FruitsTitle.TextXAlignment = Enum.TextXAlignment.Left
    FruitsTitle.Parent = ContentFrame
    
    _G.FruitsLabel = Instance.new("TextLabel")
    _G.FruitsLabel.Name = "Fruits"
    _G.FruitsLabel.BackgroundTransparency = 1
    _G.FruitsLabel.Position = UDim2.new(0, 10, 0, 145)
    _G.FruitsLabel.Size = UDim2.new(1, -20, 0, 20)
    _G.FruitsLabel.Font = Enum.Font.Gotham
    _G.FruitsLabel.Text = "No fruits"
    _G.FruitsLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    _G.FruitsLabel.TextSize = 14
    _G.FruitsLabel.TextXAlignment = Enum.TextXAlignment.Left
    _G.FruitsLabel.Parent = ContentFrame
    

    -- Nút hiển thị GUI khi đã thu nhỏ
    local ShowButton = Instance.new("TextButton")
    ShowButton.Name = "ShowButton"
    ShowButton.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    ShowButton.BorderSizePixel = 0
    ShowButton.Position = UDim2.new(0, 10, 0, 10)
    ShowButton.Size = UDim2.new(0, 40, 0, 40)
    ShowButton.Font = Enum.Font.GothamBold
    ShowButton.Text = "TG"
    ShowButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    ShowButton.TextSize = 16
    ShowButton.Visible = false
    ShowButton.Parent = BFGui
    
    -- Bo góc nút hiển thị
    local ShowCorner = Instance.new("UICorner")
    ShowCorner.CornerRadius = UDim.new(0, 8)
    ShowCorner.Parent = ShowButton
    
    -- Bóng đổ cho nút hiển thị
    local ShowShadow = Instance.new("ImageLabel")
    ShowShadow.Name = "Shadow"
    ShowShadow.BackgroundTransparency = 1
    ShowShadow.Position = UDim2.new(0, -5, 0, -5)
    ShowShadow.Size = UDim2.new(1, 10, 1, 10)
    ShowShadow.ZIndex = -1
    ShowShadow.Image = "rbxassetid://6014261993"
    ShowShadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
    ShowShadow.ImageTransparency = 0.5
    ShowShadow.ScaleType = Enum.ScaleType.Slice
    ShowShadow.SliceCenter = Rect.new(49, 49, 450, 450)
    ShowShadow.Parent = ShowButton
    
    -- Nút điều chỉnh kích thước
    local ResizeButton = Instance.new("TextButton")
    ResizeButton.Name = "ResizeButton"
    ResizeButton.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    ResizeButton.BorderSizePixel = 0
    ResizeButton.Position = UDim2.new(1, -15, 1, -15)
    ResizeButton.Size = UDim2.new(0, 15, 0, 15)
    ResizeButton.Text = ""
    ResizeButton.Parent = MainFrame
    
    -- Hình tam giác nhỏ cho nút điều chỉnh kích thước
    local ResizeIcon = Instance.new("Frame")
    ResizeIcon.Name = "ResizeIcon"
    ResizeIcon.BackgroundColor3 = Color3.fromRGB(150, 150, 150)
    ResizeIcon.BorderSizePixel = 0
    ResizeIcon.Position = UDim2.new(0, 5, 0, 5)
    ResizeIcon.Size = UDim2.new(0, 5, 0, 5)
    ResizeIcon.Parent = ResizeButton
    
    -- Bo góc nút điều chỉnh kích thước
    local ResizeCorner = Instance.new("UICorner")
    ResizeCorner.CornerRadius = UDim.new(0, 2)
    ResizeCorner.Parent = ResizeButton
    
    -- Thêm chức năng kéo thả cho MainFrame
    local isDragging = false
    local dragInput
    local dragStart
    local startPos
    
    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            isDragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    isDragging = false
                end
            end)
        end
    end)
    
    TitleBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    game:GetService("UserInputService").InputChanged:Connect(function(input)
        if input == dragInput and isDragging then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    
    -- Thêm chức năng điều chỉnh kích thước
    local isResizing = false
    local minSize = Vector2.new(300, 200)
    local maxSize = Vector2.new(700, 500)
    
    ResizeButton.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            isResizing = true
            dragStart = input.Position
            startSize = MainFrame.Size
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    isResizing = false
                end
            end)
        end
    end)
    
    game:GetService("UserInputService").InputChanged:Connect(function(input)
        if isResizing and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            local newSize = UDim2.new(
                startSize.X.Scale, 
                math.clamp(startSize.X.Offset + delta.X, minSize.X, maxSize.X), 
                startSize.Y.Scale, 
                math.clamp(startSize.Y.Offset + delta.Y, minSize.Y, maxSize.Y)
            )
            MainFrame.Size = newSize
        end
    end)
    
    -- Chức năng đóng/mở GUI và blur
    CloseButton.MouseButton1Click:Connect(function()
        MainFrame.Visible = false
        ShowButton.Visible = true
        -- Tắt hiệu ứng blur khi đóng GUI
        BlurManager.ToggleBlur(false)
    end)
    
    ShowButton.MouseButton1Click:Connect(function()
        MainFrame.Visible = true
        ShowButton.Visible = false
        -- Áp dụng hiệu ứng blur khi mở GUI
        BlurManager.ToggleBlur(true)
    end)
    
    -- Chức năng thu nhỏ/phóng to
    local isMinimized = false
    local originalSize
    
    MinimizeButton.MouseButton1Click:Connect(function()
        if isMinimized then
            -- Phóng to
            MainFrame.Size = originalSize
            ContentFrame.Visible = true
            MinimizeButton.Text = "-"
            isMinimized = false
        else
            -- Thu nhỏ
            originalSize = MainFrame.Size
            MainFrame.Size = UDim2.new(0, MainFrame.Size.X.Offset, 0, 40)
            ContentFrame.Visible = false
            MinimizeButton.Text = "+"
            isMinimized = true
        end
    end)
    
    -- Áp dụng blur ban đầu khi tạo GUI
    BlurManager.ToggleBlur(true)
    
    -- Lưu vào biến toàn cục để có thể tham chiếu sau này
    _G.MainGUI = {
        ScreenGui = BFGui,
        MainFrame = MainFrame,
        ShowButton = ShowButton,
        BlurManager = BlurManager
    }
    
    return BFGui
end

-- Kiểm tra thế giới hiện tại
local function CheckCurrentWorld()
    local World1, World2, World3 = false, false, false

    if game.PlaceId == 2753915549 then
        World1 = true
        UpdateWorld("World 1")
        print("Currently in World 1")
    elseif game.PlaceId == 4442272183 then
        World2 = true
        UpdateWorld("World 2")
        print("Currently in World 2")
    elseif game.PlaceId == 7449423635 then
        World3 = true
        UpdateWorld("World 3")
        print("Currently in World 3")
    end
    
    return World1, World2, World3
end

-- Chức năng di chuyển đến vị trí
function topos(Pos)
    pcall(function()
        UpdateStatus("Moving to destination...")
        Distance = (Pos.Position - game.Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
        if game.Players.LocalPlayer.Character.Humanoid.Sit == true then game.Players.LocalPlayer.Character.Humanoid.Sit = false end
        tween = game:GetService("TweenService"):Create(game.Players.LocalPlayer.Character.HumanoidRootPart,TweenInfo.new(Distance/210, Enum.EasingStyle.Linear),{CFrame = Pos})
        tween:Play()
        if Distance <= 250 then
            tween:Cancel()
            game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = Pos
        end
    end)
end

function StopTween()
    pcall(function()
        if tween then
            tween:Cancel()
        end
    end)
end

-- Kiểm tra fruit trong túi
function HasFruits()
    local fruitCount = 0
    local fruitList = ""
    
    for _, v in pairs(game.Players.LocalPlayer.Backpack:GetChildren()) do
        if string.find(v.Name, "Fruit") then
            fruitCount = fruitCount + 1
            fruitList = fruitList .. v.Name .. ", "
        end
    end
    
    for _, v in pairs(game.Players.LocalPlayer.Character:GetChildren()) do
        if string.find(v.Name, "Fruit") then
            fruitCount = fruitCount + 1
            fruitList = fruitList .. v.Name .. ", "
        end
    end
    
    if fruitCount > 0 then
        fruitList = string.sub(fruitList, 1, -3) -- Xóa dấu phẩy và khoảng trắng cuối cùng
        UpdateFruits(fruitCount .. " fruits: " .. fruitList)
    else
        UpdateFruits("No fruits")
    end
    
    return fruitCount > 0
end

-- Thả tất cả fruit
function DropAllFruits()
    UpdateStatus("Dropping fruits...")
    print("Starting to drop fruits using direct method...")
    local fruitsDropped = 0
    
    for _, v in pairs(game.Players.LocalPlayer.Backpack:GetChildren()) do
        if string.find(v.Name, "Fruit") then

            game.Players.LocalPlayer.Character.Humanoid:EquipTool(v)
            wait(1) -- Wait for equip
            
            local tool = game.Players.LocalPlayer.Character:FindFirstChildOfClass("Tool")
            if tool and string.find(tool.Name, "Fruit") then
                tool.Parent = game.Workspace
                fruitsDropped = fruitsDropped + 1
                wait(1) -- Wait between drops
            end
        end
    end
    
    local tool = game.Players.LocalPlayer.Character:FindFirstChildOfClass("Tool")
    if tool and string.find(tool.Name, "Fruit") then
        tool.Parent = game.Workspace
        fruitsDropped = fruitsDropped + 1
    end
    
    if fruitsDropped > 0 then
    else
    end
    
    if HasFruits() then
        
        for _, v in pairs(game.Players.LocalPlayer.Backpack:GetChildren()) do
            if string.find(v.Name, "Fruit") then
                game.Players.LocalPlayer.Character.Humanoid:EquipTool(v)
                wait(1)
                
                local tool = game.Players.LocalPlayer.Character:FindFirstChildOfClass("Tool")
                if tool then
                    tool.Parent = game.Workspace
                wait(1)
            end
        end
        end
        
        local tool = game.Players.LocalPlayer.Character:FindFirstChildOfClass("Tool")
        if tool and string.find(tool.Name, "Fruit") then
            tool.Parent = game.Workspace
        end
    end
    
    UpdateStatus("Fruits dropped")
    return not HasFruits()
end

-- Hàm chính chạy script
local function StartScript()
    -- Đợi người chơi chọn team
    WaitForTeamSelection()
    
    -- Sau khi đã chọn team, tạo GUI và bắt đầu chạy
    local gui = CreateGUI()
    
    -- Kiểm tra thế giới hiện tại
    local World1, World2, World3 = CheckCurrentWorld()
    
    local GachaPosition = CFrame.new(-506.71295166015625, 318.7607116699219, 471.9562072753906)
    
    spawn(function()
        -- Kiểm tra và chuyển đến World 2 nếu cần
        while wait(1) do
            if not World2 then
                UpdateStatus("Teleporting to World 2...")
                print("Not in World 2. Teleporting to World 2...")
                if World1 then
                    game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("TravelDressrosa")
                    wait(5) -- Wait for teleport to complete
                elseif World3 then
                    game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("TravelDressrosa")
                    wait(5) -- Wait for teleport to complete
                end
            else
                break -- Exit the loop once we're in World 2
            end
        end
        
        -- Kiểm tra xem đã có fruit chưa
        HasFruits() -- Update fruit status in GUI
        
        -- Nếu đã có fruit, thì thả fruit
        if HasFruits() then
            print("Already have fruits, dropping them...")
            local currentPos = game.Players.LocalPlayer.Character.HumanoidRootPart.Position
            local targetPos = GachaPosition.Position
            local distance = (targetPos - currentPos).Magnitude
            
            if distance > 10 then
                topos(GachaPosition)
                
                local waitTime = math.min(distance / 210, 10) + 1
                wait(waitTime)
                
                if (game.Players.LocalPlayer.Character.HumanoidRootPart.Position - targetPos).Magnitude <= 20 then
                    DropAllFruits()
                    UpdateStatus("Task completed: Fruits dropped!")
                end
            else
                DropAllFruits()
                UpdateStatus("Task completed: Fruits dropped!")
            end
            
            return -- Dừng script sau khi thả fruit
        end
        
        -- Nếu chưa có fruit, mua fruit mới
        UpdateStatus("Buying random fruit...")
        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("Cousin","Buy")
        wait(2) -- Wait longer for purchase to complete
        
        HasFruits() -- Update fruit status after purchase
        
        if HasFruits() then
            print("Successfully purchased a fruit, dropping it...")
            local currentPos = game.Players.LocalPlayer.Character.HumanoidRootPart.Position
            local targetPos = GachaPosition.Position
            local distance = (targetPos - currentPos).Magnitude
            
            if distance > 10 then
                topos(GachaPosition)
                
                local waitTime = math.min(distance / 210, 10) -- Cap at 10 seconds max
                wait(waitTime + 2) -- Add extra buffer
                
                local newDistance = (game.Players.LocalPlayer.Character.HumanoidRootPart.Position - targetPos).Magnitude
                if newDistance <= 20 then
                    DropAllFruits()
                    UpdateStatus("Task completed: Fruit purchased and dropped!")
                    wait(2) -- Wait for 2 seconds before disconnecting
                    game:Shutdown() -- Disconnect/shutdown the game client
                else
                    print("Failed to reach Gacha, distance: " .. newDistance)
                    UpdateStatus("Failed to reach destination")
                end
            else
                DropAllFruits()
                UpdateStatus("Task completed: Fruit purchased and dropped!")
                wait(2) -- Wait for 2 seconds before disconnecting
                game:Shutdown() -- Disconnect/shutdown the game client
            end
        else
            print("No fruit obtained from purchase")
            UpdateStatus("No fruit obtained, task complete.")
        end
    end)
end

-- Bắt đầu chạy script
StartScript() 
